#!/usr/bin/env zsh
###########################################################
# dot-stow-manager: dot-stow-watch manager
# Spawn dot-stow-watches (instances of dot-stow-watch)
# for each desired symlink farm
# Note: these directories need to be specified in STOW_DIRS
###########################################################

# Allow job control on this one, please
setopt monitor

# clean up all child processes created by
# this one
__clean_up() {
    for job in $(jobs -l | egrep -o "([0-9][0-9]+)"); do
        kill -TERM $job
    done
    unset job
}

# register UNIX signals
trap __clean_up SIGHUP SIGTERM SIGINT

# spawn dot-stow-watch processes for each directory in $STOW_DIRS
for stow_dir in $(echo $STOW_DIRS | tr ':' ' '); do
    dot-stow-watch $stow_dir | logger &
done
unset stow_dir

# Wait for child processes to finish
wait
exit 0
