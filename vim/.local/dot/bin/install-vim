#!/usr/bin/env zsh
##################################
# Install vim + Vundle + plugins
##################################

autoload dot_printf_install

# Basic stuff needed to have ruby support
ruby_home=~/.rvm/rubies/ruby-1.9.3-p551/bin/ruby

# The actual variables for vim compilation
vim_git=https://github.com/vim/vim.git
vim_src=~/Projects/vim
vim_deps=(vim-gtk)
vim_pkgs=(exuberant-ctags)
vim_opts=(\
          --prefix=$DOT_PATH \
          --enable-pythoninterp=yes \
          --enable-rubyinterp=yes \
          --with-ruby-command=$ruby_home \
          --with-features=huge \
          --enable-gui=gtk2 \
          --enable-cscope \
          )
vim_sudo_bin=/usr/local/bin/vim
cc_cores=$(( $(nproc) - 1 )) # Number of cores used for compilation

# Vundle-related variables
vundle_git=https://github.com/VundleVim/Vundle.vim.git
vundle_src=~/.vim/bundle/Vundle.vim

dot_printf_install "vim dependencies"

# First of all, we need some dependencies
sudo apt-get install -y "${vim_pkgs[@]}"
sudo apt-get build-dep -y "${vim_deps[@]}"

# Now, we do the thing
dot_printf_install "vim"

# Clone/pull the repo
if [ ! -d $vim_src ]; then
    git clone $vim_git $vim_src
else
    git -C $vim_src pull
fi

# Compile and install vim
cd $vim_src && make clean && make distclean && \
    ./configure "${vim_opts[@]}" && make -j $cc_cores install

# Symlink vim so it can be available systemwide
dot_printf_install "Symlink to ${vim_sudo_bin}"
sudo ln -svf $(which vim) $vim_sudo_bin

# Set up Vundle and install plugins
dot_printf_install Vundle
if [ ! -d $vundle_src ]; then
    git clone $vundle_git $vundle_src
else
    git -C $vundle_src pull
fi

dot_printf_install "Vundle plugins"
vim +PluginInstall +qall
